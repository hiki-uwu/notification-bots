name: check-stock

on:
  workflow_dispatch:   # Enables the "Run workflow" button in Actions
  schedule:
    - cron: "*/30 * * * *"  # Runs every 30 minutes

jobs:
  run-container:
    runs-on: ubuntu-latest
    steps:
      # Authenticate with GHCR
      - name: Log in to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      # Restore cached Docker image if available
      - name: Restore cached image
        uses: actions/cache@v3
        with:
          path: /tmp/docker-cache
          key: docker-image-amul-bot

      # Pull if no cache exists, otherwise load from cache
      - name: Load or Pull Image
        run: |
          mkdir -p /tmp/docker-cache
          if [ -f /tmp/docker-cache/amul-bot.tar ]; then
            echo "Loading Docker image from cache..."
            docker load -i /tmp/docker-cache/amul-bot.tar
          else
            echo "Pulling image from GHCR and caching..."
            docker pull ghcr.io/hiki-uwu/amul-bot:latest
            docker save ghcr.io/hiki-uwu/amul-bot:latest -o /tmp/docker-cache/amul-bot.tar
          fi

      # Run the container with environment variables
      - name: Run container
        run: |
          docker run --rm \
            -e PINCODE=${{ secrets.PINCODE }} \
            -e TWILIO_SID=${{ secrets.TWILIO_SID }} \
            -e TWILIO_AUTH=${{ secrets.TWILIO_AUTH }} \
            -e TWILIO_FROM=${{ secrets.TWILIO_FROM }} \
            -e TWILIO_TO=${{ secrets.TWILIO_TO }} \
            ghcr.io/hiki-uwu/amul-bot:latest


